# DE AGENT

### Общая архитектура

Система представляет собой **LLM-ассистента для дата-инженеров**, позволяющего через чат создавать пайплайны загрузки данных. Архитектура состоит из четырёх основных микросервисов и трёх вспомогательных инфраструктурных компонентов, объединённых в единую Docker-сеть через `docker-compose`.

---

### Основные сервисы

| Сервис      | Назначение | Порт (внешний → внутренний) |
|-------------|-----------|-----------------------------|
| **frontend** | Веб-интерфейс чата с LDAP-авторизацией | `8003 → 8080` |
| **backend**  | API для чата, интеграция с MCP и агентом, работа с БД | `8002 → 8080` |
| **mcp**      | **MCP-сервер** — универсальный шлюз к инфраструктуре (БД, S3, GitLab, Airflow) | `8001 → 8080` |
| **agent**    | GitLab-агент — обрабатывает issue, создаёт MR, взаимодействует с GitLab и Airflow | `8000 → 8080` |

---

### Инфраструктурные компоненты

| Компонент   | Назначение | Порт |
|------------|-----------|------|
| **postgres** | Хранение данных чата и метаинформации (с поддержкой векторных операций через `pgvector`) | `5431 → 5432` |
| **minio**    | S3-совместимое хранилище для файлов (CSV, JSON, Parquet и др.) | `9000 → 9000` (API), `9001 → 9001` (консоль) |
| **kroki**    | Сервис рендеринга диаграмм (PlantUML, Mermaid и др.) для визуализации в чате | `8008 → 8000` |

---

### Взаимодействие компонентов

1. **Пользователь** заходит в **frontend** (`http://localhost:8003`), проходит LDAP-авторизацию.
2. Все запросы от фронтенда идут в **backend** по адресу `http://backend:8080` (внутри Docker-сети).
3. **Backend**:
   - Сохраняет историю чата в **PostgreSQL**.
   - При необходимости вызывает **MCP-сервер** для доступа к внешним системам (БД, хранилища, GitLab).
   - Может инициировать создание GitLab issue → это запускает **agent** через webhook.
4. **MCP-сервер**:
   На стороне MCP сервера реализовано взаимодействие со следующими объектами:

   - Базы данных, все, для которых есть драйвера для `sqlalchemy`
   - Файловые хранилища (S3, SMB)
   - Kafka
   - Веб интерфейсы
   
   Для файловых хранилищ поддерживаются следующие форматы данных:
   - CSV, TSV
   - JSON, XML
   - Parquet
   
   Основные действия над базами данных:
   - проверить доступность
   - проверить наличие схемы.таблицы
   - получить DDL (структуру таблицы)
   - получить sample данных для проверки структуры таблицы
   
   Основные действия над хранилищами
   - проверить доступность хранилища
   - проверить доступность каталога и проверить наличие файла
   - прочитать файл или его часть (для текстовых форматов)
   - получить схему для parquet файлов
   
   Основные действия над интернет ресурсами
   - проверить доступность ресурса
   - получить первые 2000 символов ответа ресурса

   Используется как **единая точка интеграции** для LLM-логики.

5. **Agent**:
   - Слушает вебхуки от GitLab.
   - При создании issue — читает данные, генерирует код пайплайна, создаёт ветку и MR в GitLab.
   - После принятия MR — изменения автоматически попадают в **Airflow** (внешняя система).
6. **MinIO**:
   - Используется для хранения загружаемых пользователем файлов и промежуточных данных.
   - Бакеты `upload` и `images` автоматически создаются при старте и настроены как **публичные для чтения**.
7. **Kroki**:
   - Вызывается MCP или backend для рендеринга диаграмм по текстовому описанию (например, схемы ETL-пайплайна).

---

### Сетевая модель

Все сервисы работают в одной Docker-сети (создаётся автоматически `docker-compose`).  
Внутренние вызовы используют **DNS-имена сервисов**:
- `http://backend:8080`
- `http://minio:9000`
- `http://postgres:5432`
- `http://kroki:8000`
- `http://mcp:8080`

Это обеспечивает **изоляцию от localhost** и корректную работу в контейнерной среде.

---

### Преимущества подхода

- Полная **локальная воспроизводимость** стенда.
- Чёткое разделение ответственности между компонентами.
- Гибкая настройка через `.env` и build-аргументы.
- Поддержка enterprise-интеграций (LDAP, GitLab, Airflow, S3, Kafka).

---

Такой стенд идеально подходит как для **демонстрации**, так и для **локальной разработки и тестирования** всего LLM-ассистента «из коробки».

# Описание зависимостей


## **1. Внешние зависимости**  
Переменные, которые указывают на **внешние системы**, не входящие в текущий `docker-compose`-стенд. Их значения зависят от инфраструктуры тестовой среды.

| Переменная | Описание | Используется в |
|-----------|--------|----------------|
| `API_KEY` | Ключ доступа к внешнему LLM API (например, YandexGPT, OpenRouter и т.п.) | `backend`, `agent` |
| `BASE_URL` | Базовый URL внешнего LLM API | `backend`, `agent` |
| `FOLDER` | Имя проекта в YandexCloud | `backend`, `agent` |
| `MODEL_NAME` | Имя модели LLM, которую следует использовать | `backend`, `agent` |
| `LDAP_SERVER` | IP-адрес или домен LDAP-сервера для авторизации пользователей | `backend` |
| `LDAP_PORT` | Порт LDAP-сервера (обычно 389 или 1389) | `backend` |
| `GITLAB_URL` | URL вашего GitLab-инстанса (например, `https://gitlab.example.com`) | `mcp`, `agent` |
| `GITLAB_TOKEN` | Персональный токен доступа к GitLab API с правами на запись | `mcp`, `agent` |
| `PROJECT_PATH` | Путь к проекту в GitLab в формате `group/project` | `mcp`, `agent` |
| `AIRFLOW_URL` | URL Airflow REST API (например, `http://airflow.example.com/api/v1`) | `mcp`, `agent` |
| `AIRFLOW_USER` | Имя пользователя Airflow с доступом к API | `mcp`, `agent` |
| `AIRFLOW_PASSWORD` | Пароль пользователя Airflow | `mcp`, `agent` |
| `HTTPS_PROXY` | Адрес HTTPS-прокси (если требуется доступ в интернет через прокси) | `frontend`, `backend`, `mcp`, `agent` |
| `HTTP_PROXY` | Адрес HTTP-прокси (опционально, часто дублирует HTTPS_PROXY) | —  |

> Эти переменные **обязательно нужно задавать** при развёртывании в реальной среде. Они **не могут быть "по умолчанию"**, так как указывают на уникальные внешние сервисы.

---

## **2. Внутренние зависимости**  
Переменные, которые управляют **внутренней конфигурацией стенда** и могут иметь разумные значения по умолчанию. Их можно зафиксировать в `.env` для локального запуска.

| Переменная | Значение по умолчанию | Описание | Используется в |
|-----------|----------------------|--------|----------------|
| `POSTGRES_USER` | `test` | Имя пользователя PostgreSQL | `postgres`, `backend`, `agent` |
| `POSTGRES_PASSWORD` | `test` | Пароль пользователя PostgreSQL | `postgres`, `backend`, `agent` |
| `POSTGRES_DB` | `chat` | Имя базы данных чата | `postgres`, `backend`, `agent` |
| `MCP_CONFIG` | `./mcp_config.json` | Путь к JSON-конфигурации доступных инструментов для MCP-сервера | `backend`, `agent` |



