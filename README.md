# DE AGENT

### Общая архитектура

Система представляет собой **LLM-ассистента для дата-инженеров**, позволяющего через чат создавать пайплайны загрузки данных. Архитектура состоит из четырёх основных микросервисов и трёх вспомогательных инфраструктурных компонентов, объединённых в единую Docker-сеть через `docker-compose`.

---

### Основные сервисы

| Сервис      | Назначение | Порт (внешний → внутренний) |
|-------------|-----------|-----------------------------|
| **frontend** | Веб-интерфейс чата с LDAP-авторизацией | `8003 → 8080` |
| **backend**  | API для чата, интеграция с MCP и агентом, работа с БД | `8002 → 8080` |
| **mcp**      | **MCP-сервер** — универсальный шлюз к инфраструктуре (БД, S3, GitLab, Airflow) | `8001 → 8080` |
| **agent**    | GitLab-агент — обрабатывает issue, создаёт MR, взаимодействует с GitLab и Airflow | `8000 → 8080` |

---

### Инфраструктурные компоненты

| Компонент   | Назначение | Порт |
|------------|-----------|------|
| **postgres** | Хранение данных чата и метаинформации (с поддержкой векторных операций через `pgvector`) | `5431 → 5432` |
| **minio**    | S3-совместимое хранилище для файлов (CSV, JSON, Parquet и др.) | `9000 → 9000` (API), `9001 → 9001` (консоль) |
| **kroki**    | Сервис рендеринга диаграмм (PlantUML, Mermaid и др.) для визуализации в чате | `8008 → 8000` |

---

### Взаимодействие компонентов

1. **Пользователь** заходит в **frontend** (`http://localhost:8003`), проходит LDAP-авторизацию.
2. Все запросы от фронтенда идут в **backend** по адресу `http://backend:8080` (внутри Docker-сети).
3. **Backend**:
   - Сохраняет историю чата в **PostgreSQL**.
   - При необходимости вызывает **MCP-сервер** для доступа к внешним системам (БД, хранилища, GitLab).
   - Может инициировать создание GitLab issue → это запускает **agent** через webhook.
4. **MCP-сервер**:
   На стороне MCP сервера реализовано взаимодействие со следующими объектами:

   - Базы данных, все, для которых есть драйвера для `sqlalchemy`
   - Файловые хранилища (S3, SMB)
   - Kafka
   - Веб интерфейсы
   
   Для файловых хранилищ поддерживаются следующие форматы данных:
   - CSV, TSV
   - JSON, XML
   - Parquet
   
   Основные действия над базами данных:
   - проверить доступность
   - проверить наличие схемы.таблицы
   - получить DDL (структуру таблицы)
   - получить sample данных для проверки структуры таблицы
   
   Основные действия над хранилищами
   - проверить доступность хранилища
   - проверить доступность каталога и проверить наличие файла
   - прочитать файл или его часть (для текстовых форматов)
   - получить схему для parquet файлов
   
   Основные действия над интернет ресурсами
   - проверить доступность ресурса
   - получить первые 2000 символов ответа ресурса

   Используется как **единая точка интеграции** для LLM-логики.

5. **Agent**:
   - Слушает вебхуки от GitLab.
   - При создании issue — читает данные, генерирует код пайплайна, создаёт ветку и MR в GitLab.
   - После принятия MR — изменения автоматически попадают в **Airflow** (внешняя система).
6. **MinIO**:
   - Используется для хранения загружаемых пользователем файлов и промежуточных данных.
   - Бакеты `upload` и `images` автоматически создаются при старте и настроены как **публичные для чтения**.
7. **Kroki**:
   - Вызывается MCP или backend для рендеринга диаграмм по текстовому описанию (например, схемы ETL-пайплайна).

---

### Сетевая модель

Все сервисы работают в одной Docker-сети (создаётся автоматически `docker-compose`).  
Внутренние вызовы используют **DNS-имена сервисов**:
- `http://backend:8080`
- `http://minio:9000`
- `http://postgres:5432`
- `http://kroki:8000`
- `http://mcp:8080`

Это обеспечивает **изоляцию от localhost** и корректную работу в контейнерной среде.

---

### Преимущества подхода

- Полная **локальная воспроизводимость** стенда.
- Чёткое разделение ответственности между компонентами.
- Гибкая настройка через `.env` и build-аргументы.
- Поддержка enterprise-интеграций (LDAP, GitLab, Airflow, S3, Kafka).

---

Такой стенд идеально подходит как для **демонстрации**, так и для **локальной разработки и тестирования** всего LLM-ассистента «из коробки».